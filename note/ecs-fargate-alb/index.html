<!DOCTYPE html>
<html>
    <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Setup for ECS/Fargate with application load balancer">
  <meta name="author" content="Valerii Lysenko" />

  <link rel="stylesheet" type="text/css" href="/css/normalize.css">
  <link rel="stylesheet" type="text/css" href="/css/syntax.css">
  
  
  <link rel="stylesheet" type="text/css" href="/css/cloud.css">

  
  
  <title>vallyscode&#39;s notes | Ecs Fargate ALB</title>
  

  
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-142469594-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '367129371');
</script>
</head>
    <body>
        <header>
  <nav class="navigation">
    
    <a href="/">
      
      Notes
    </a>
    
    <a href="/tags/">
      
      Tags
    </a>
    
    <a href="/about/">
      
      About
    </a>
    
  </nav>
</header>
        
<main>
  <article class='note'>
    <header>
      <h1 class='title'>
        Ecs Fargate ALB
      </h1>
      
      
      <time class='published' datetime='2023-06-15'>
        June 15, 2023
      </time>
      
      <nav class='tags'>
        
        <a class="tag" href='/tags/aws/'>aws</a>
        
        <a class="tag" href='/tags/ecs/'>ecs</a>
        
        <a class="tag" href='/tags/fargate/'>fargate</a>
        
        <a class="tag" href='/tags/alb/'>alb</a>
        
      </nav>
      
    </header>
    <p>As a managed container orchetration service it greatly help in deploying and management of containerized applications, it allows to focus more on building the app itself rather than spending resources on environment.</p>
<h2 id="ecr">ECR</h2>
<p>Is a fully managed container registry, offering nice features like image scan on push (awesome security related feature), image lifecycle policies (removing outdated or keeping only desired number of images), and nicely integrates with other service.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">Repository</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::ECR::Repository</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">RepositoryName</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${Env}-${ServiceName}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ImageScanningConfiguration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ScanOnPush</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>In order to push images to registry, we must login</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">aws ecr get-login-password --region <span class="k">$(</span>REGION<span class="k">)</span> <span class="p">|</span> docker login --username AWS --password-stdin <span class="k">$(</span>ACCOUNT<span class="k">)</span>.dkr.ecr.<span class="k">$(</span>REGION<span class="k">)</span>.amazonaws.com
</span></span></code></pre></div><p>So now we can push images</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker push <span class="k">$(</span>ACCOUNT<span class="k">)</span>.dkr.ecr.<span class="k">$(</span>REGION<span class="k">)</span>.amazonaws.com/<span class="k">$(</span>STAGE<span class="k">)</span>-<span class="k">$(</span>name<span class="k">)</span> --all-tags
</span></span></code></pre></div><p>Simple as that.</p>
<h2 id="cluster">Cluster</h2>
<p>ECS cluster with provider type <code>Fargate</code> also is simple to define.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">EcsCluster</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::ECS::Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ClusterName</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${Env}-${ServiceName}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ClusterSettings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l">containerInsights</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l">enabled</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">CapacityProviders</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">FARGATE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">DefaultCapacityProviderStrategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">CapacityProvider</span><span class="p">:</span><span class="w"> </span><span class="l">FARGATE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Weight</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Tags</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l">Env</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref Env</span><span class="w">
</span></span></span></code></pre></div><p>This will provision a new cluster with container insights enabled, showing us cpu, memory, network, service count information for our cluster.</p>
<p>Our cluster will require permissions to access <code>ECR</code> and execute service tasks so we also need a role for that</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">EcsExecutionRole</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::IAM::Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">RoleName</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${Env}-${ServiceName}-ecs-execution</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">Statement</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">Principal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">Service</span><span class="p">:</span><span class="w"> </span><span class="l">ecs-tasks.amazonaws.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;sts:AssumeRole&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ManagedPolicyArns</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy</span><span class="w">
</span></span></span></code></pre></div><h2 id="alb">ALB</h2>
<p>Yet another fully managed service allowing incoming traffic distribution across multiple targets, be it containers, EC2, some IP in different availability zones (AZs).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">LoadBalancer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::ElasticLoadBalancingV2::LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l">${Env}-${ServiceName}-balancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Scheme</span><span class="p">:</span><span class="w"> </span><span class="l">internal</span><span class="w"> </span><span class="c"># or &#39;internet-facing&#39; for public one</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">LoadBalancerAttributes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l">idle_timeout.timeout_seconds</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">SecurityGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- !<span class="l">Ref LoadBalancerSecurityGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Subnets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- !<span class="l">Ref SubnetA</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- !<span class="l">Ref SubnetB</span><span class="w">
</span></span></span></code></pre></div><p>This one is <strong>private</strong> and will operate in specified subnets, guarded by security group</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">LoadBalancerSecurityGroup</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::EC2::SecurityGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">GroupName</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${Env}-${ServiceName}-balancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">GroupDescription</span><span class="p">:</span><span class="w"> </span><span class="l">Security group for load balancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">VpcId</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref VpcId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">SecurityGroupIngress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">IpProtocol</span><span class="p">:</span><span class="w"> </span><span class="l">tcp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">FromPort</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref LoadBalancerPort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ToPort</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref LoadBalancerPort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">CidrIp</span><span class="p">:</span><span class="w"> </span><span class="m">0.0.0.0</span><span class="l">/0</span><span class="w">
</span></span></span></code></pre></div><p>We will add a dedicated listener for missing routes</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">Listener</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::ElasticLoadBalancingV2::Listener</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">DefaultActions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">fixed-response</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">FixedResponseConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">StatusCode</span><span class="p">:</span><span class="w"> </span><span class="m">404</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">LoadBalancerArn</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Port</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref LoadBalancerPort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Protocol</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w"> </span><span class="c"># HTTPS in case if it&#39;s public</span><span class="w">
</span></span></span></code></pre></div><p>So now there will be auto <code>404</code> for invalid requests and no traffic reach the target group.</p>
<h2 id="service">Service</h2>
<p>Getting closer to the service itself</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">Service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::ECS::Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Cluster</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ServiceName</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${Env}-${ServiceName}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">TaskDefinition</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref Task</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">DeploymentConfiguration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">MinimumHealthyPercent</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">MaximumPercent</span><span class="p">:</span><span class="w"> </span><span class="m">200</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">DesiredCount</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">HealthCheckGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">LaunchType</span><span class="p">:</span><span class="w"> </span><span class="l">FARGATE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">NetworkConfiguration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">AwsvpcConfiguration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">AssignPublicIp</span><span class="p">:</span><span class="w"> </span><span class="l">DISABLED</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Subnets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- !<span class="l">Ref SubnetA</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- !<span class="l">Ref SubnetB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">SecurityGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- !<span class="l">Ref ServiceSecutiryGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">LoadBalancers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">ContainerName</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${Env}-${ServiceName}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ContainerPort</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref ContainerPort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">TargetGroupArn</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref TargetGroup</span><span class="w">
</span></span></span></code></pre></div><p>Service will be guarded by own security group which will allow traffic from load balancer</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">ServiceSecutiryGroup</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::EC2::SecurityGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">GroupName</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${Env}-${ServiceName}-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">GroupDescription</span><span class="p">:</span><span class="w"> </span><span class="l">Security group for service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">VpcId</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref VpcId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">SecurityGroupIngress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">IpProtocol</span><span class="p">:</span><span class="w"> </span><span class="l">tcp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">FromPort</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref ContainerPort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ToPort</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref ContainerPort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">SourceSecurityGroupId</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref LoadBalancerSecurityGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">SecurityGroupEgress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">IpProtocol</span><span class="p">:</span><span class="w"> </span><span class="l">tcp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">FromPort</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref ContainerPort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ToPort</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref ContainerPort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">DestinationSecurityGroupId</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref LoadBalancerSecurityGroup</span><span class="w">
</span></span></span></code></pre></div><p>And our task definition</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">Task</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::ECS::TaskDefinition</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Cpu</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref Cpu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Memory</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref Memory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">NetworkMode</span><span class="p">:</span><span class="w"> </span><span class="l">awsvpc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">RequiresCompatibilities</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">FARGATE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ContainerDefinitions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">Name</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${Env}-${ServiceName}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Image</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref Image</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">Name</span><span class="p">:</span><span class="w"> </span><span class="l">PORT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref ContainerPort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">PortMappings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">ContainerPort</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref ContainerPort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">HostPort</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref ContainerPort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">LogConfiguration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">LogDriver</span><span class="p">:</span><span class="w"> </span><span class="l">awslogs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">Options</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">awslogs-region</span><span class="p">:</span><span class="w"> </span><span class="l">${opt:region}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">awslogs-group</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref LogGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">awslogs-stream-prefix</span><span class="p">:</span><span class="w"> </span><span class="l">ecs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ExecutionRoleArn</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref EcsExecutionRoleArn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">TaskRoleArn</span><span class="p">:</span><span class="w"> </span>!<span class="l">GetAtt TaskRole.Arn</span><span class="w">
</span></span></span></code></pre></div><p>We are using execution role defined previously plus additional role allowing out task to interact with other aws services.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">TaskRole</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::IAM::Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">RoleName</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${Env}-${ServiceName}-task</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">AssumeRolePolicyDocument</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">Statement</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">Principal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">Service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="l">ecs-tasks.amazonaws.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">Action</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s1">&#39;sts:AssumeRole&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Policies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">PolicyName</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${Env}-${ServiceName}-task</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">PolicyDocument</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">Statement</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l">Allow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Action</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">logs:PutLogEvents</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Resource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- !<span class="l">GetAtt LogGroup.Arn</span><span class="w">
</span></span></span></code></pre></div><p>In addition to that we need a log group to have a view on what&rsquo;s being logged by our app.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">LogGroup</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::Logs::LogGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">LogGroupName</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub &#39;/ecs/${Env}-${ServiceName}-task&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">RetentionInDays</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span></code></pre></div><p>In order get flow from ALB, we need to attach listener rule</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">ListenerRule</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::ElasticLoadBalancingV2::ListenerRule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Actions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">forward</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ForwardConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">TargetGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">TargetGroupArn</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref TargetGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Weight</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">Field</span><span class="p">:</span><span class="w"> </span><span class="l">path-pattern</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="l">/service/*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ListenerArn</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref ListenerArn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Priority</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span></code></pre></div><p>This will grab everything that&rsquo;s matching the patern and direct to specified target group</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">TargetGroup</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l">AWS::ElasticLoadBalancingV2::TargetGroup</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">HealthCheckIntervalSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">HealthCheckPath</span><span class="p">:</span><span class="w"> </span><span class="l">/service/healthcheck</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">HealthCheckTimeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">UnhealthyThresholdCount</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">HealthyThresholdCount</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Name</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${Env}-${ServiceName}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Port</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref ContainerPort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Protocol</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">TargetGroupAttributes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l">deregistration_delay.timeout_seconds</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="c"># default is 300</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l">stickiness.enabled</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l">stickiness.type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="l">lb_cookie</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">Key</span><span class="p">:</span><span class="w"> </span><span class="l">stickiness.lb_cookie.duration_seconds</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">Value</span><span class="p">:</span><span class="w"> </span><span class="m">54000</span><span class="w"> </span><span class="c"># 15h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">TargetType</span><span class="p">:</span><span class="w"> </span><span class="l">ip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">VpcId</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref VpcId</span><span class="w">
</span></span></span></code></pre></div><p>Here we event have sticky session configured, can be easily removed or changed to another balancing algorythm.</p>
<p>That&rsquo;s it, we have a full chain from alb to service tasks and ecr for managing images.</p>
<h2 id="conclusion">Conclusion</h2>
<p>At first sight configuration can look like a lot to do but only for the first time, next services will require only making dedicated listener rules and service tasks. At the same time as it&rsquo;s fully managed almost everything is handled for us so we can focus on development more than supporting things around it.</p>

  </article>
</main>

        <footer class="copyright">
  
  <p>© 2023 VALERII LYSENKO</p>
  
</footer>
    </body>
</html>
