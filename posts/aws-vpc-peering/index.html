<!DOCTYPE html>
<html lang="en-us"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Simple example of AWS VPC peering configuration">
    <meta name="author" content="Valerii Lysenko"/>
    
    <link rel="stylesheet" type="text/css" href="/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="/css/cloud.css">
    <link rel="stylesheet" type="text/css" href="/css/syntax.css">
    
    
    
    <title>vally&#39;s code | Aws Vpc Peering</title>

    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-142469594-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-142469594-1');
</script>
</head>
<body><header>
  <nav>
    <ul>
      
      <li>
        <a href="/">
        
        Blog
        </a>
      </li>
      
      <li>
        <a href="/tags/">
        
        Tags
        </a>
      </li>
      
      <li>
        <a href="/about/">
        
        About
        </a>
      </li>
      
    </ul>
  </nav>
</header>


<main>

  <article class="article">

    <section class="article-title">
      <h2><a href="/posts/aws-vpc-peering/">Aws Vpc Peering</a></h2>
    </section>

    <section class="article-time">
  
  
  <time datetime="2020-11-02">November 2, 2020</time>
</section>


<section class="tags">
  
    
    
    <a href="https://vallyscode.github.io/tags/aws">aws</a>
    
    
    <a href="https://vallyscode.github.io/tags/vpc">vpc</a>
    
    
    <a href="https://vallyscode.github.io/tags/cloudformation">cloudformation</a>
    
  
</section>


    <section class="article-content">
      <p>Simple example of AWS VPC peering configuration via cloudformation</p>
<h2 id="use-case">Use case</h2>
<p>Peering is a networking connection between two VPCs that enables traffic routing  between them using private addresses.</p>
<blockquote>
<ul>
<li>Peering connection can be created between VPCs in same account, or with a VPC in another AWS account. Also VPCs can be from different regions (inter-region VPC peering).</li>
<li>Peering connection is a one to one relationship between two VPCs.</li>
<li>Transitive peering relationships are not supported</li>
</ul>
</blockquote>
<h4 id="simplified-diagram">Simplified diagram</h4>
<p><img src="/img/vpc-peering/vpcs-same-account-simple.png" alt="Simplified same account vpc peering:"></p>
<h4 id="more-detailed-diagram">More detailed diagram</h4>
<p><img src="/img/vpc-peering/vpcs-peering-detailed.png" alt="Simplified same account vpc peering:"></p>
<h2 id="basics">Basics</h2>
<ul>
<li>Requester VPC owner sends a request to the owner of the accepter VPC to create peering connection.</li>
<li>Accepter VPC can have same owner, or another AWS account.</li>
<li>Cannot have CIDR block that overlaps with the requester VPC&rsquo;s one.</li>
<li>Accepter VPC owner accepts peering connection request to activate the peering connection.</li>
<li>To enable the flow of traffic between the VPCs using private IP addresses, the  route should be added to corresponding route tables.</li>
<li>Edit security group rules that are associated with instance enable traffic flow to and from the peer VPC.</li>
<li>Enable DNS hostname resolution for VPC connection to force hostname resolving to the private IP address of the instance.</li>
</ul>
<h2 id="cloudformation">Cloudformation</h2>
<div class="highlight"><pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">AWSTemplateFormatVersion</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2010-09-09&#39;</span><span class="w">
</span><span class="w"></span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Simple VPC peering configuration&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">Parameters</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">Env</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;String&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">Description</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Logical environment dev|test etc&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">Resources</span><span class="p">:</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">Peering</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;AWS::EC2::VPCPeeringConnection&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">PeerOwnerId</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${AWS::AccountId}</span><span class="w">
</span><span class="w">      </span><span class="nt">PeerRegion</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub ${AWS::Region}</span><span class="w">
</span><span class="w">      </span><span class="nt">PeerVpcId</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">Fn::ImportValue</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub &#39;${Env}-vpc-a&#39;</span><span class="w">
</span><span class="w">      </span><span class="nt">VpcId</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">Fn::ImportValue</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub &#39;${Env}-vpc-b&#39;</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">PublicSubnetPeerRouteB</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;AWS::EC2::Route&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">RouteTableId</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">Fn::ImportValue</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub &#39;${Env}-public-subnet-route-table-b&#39;</span><span class="w">
</span><span class="w">      </span><span class="nt">DestinationCidrBlock</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;172.31.0.0/16&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">VpcPeeringConnectionId</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref Peering</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">PrivateSubnetPeerRouteB</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;AWS::EC2::Route&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">RouteTableId</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">Fn::ImportValue</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub &#39;${Env}-private-subnet-route-table-b&#39;</span><span class="w">
</span><span class="w">      </span><span class="nt">DestinationCidrBlock</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;172.31.0.0/16&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">VpcPeeringConnectionId</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref Peering</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">PublicSubnetPeerRouteA</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;AWS::EC2::Route&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">RouteTableId</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">Fn::ImportValue</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub &#39;${Env}-public-subnet-route-table-a&#39;</span><span class="w">
</span><span class="w">      </span><span class="nt">DestinationCidrBlock</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.0.0.0/16&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">VpcPeeringConnectionId</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref Peering</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">PrivateSubnetPeerRouteA</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;AWS::EC2::Route&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">Properties</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">RouteTableId</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">Fn::ImportValue</span><span class="p">:</span><span class="w"> </span>!<span class="l">Sub &#39;${Env}-private-subnet-route-table-a&#39;</span><span class="w">
</span><span class="w">      </span><span class="nt">DestinationCidrBlock</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.0.0.0/16&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">VpcPeeringConnectionId</span><span class="p">:</span><span class="w"> </span>!<span class="l">Ref Peering</span></code></pre></div>

    </section>

  </article>

</main>

<footer class="copyright">
    <p>© 2020 VALERII LYSENKO</p>
</footer>
</body>

</html>
